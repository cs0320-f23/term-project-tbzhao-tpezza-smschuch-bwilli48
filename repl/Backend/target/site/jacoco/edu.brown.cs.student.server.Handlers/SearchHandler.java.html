<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">s0</a> &gt; <a href="index.source.html" class="el_package">edu.brown.cs.student.server.Handlers</a> &gt; <span class="el_source">SearchHandler.java</span></div><h1>SearchHandler.java</h1><pre class="source lang-java linenums">package edu.brown.cs.student.server.Handlers;

import com.squareup.moshi.JsonAdapter;
import com.squareup.moshi.Moshi;
import com.squareup.moshi.adapters.PolymorphicJsonAdapterFactory;
import edu.brown.cs.student.CSVCode.Search.ColumnIdentifier;
import edu.brown.cs.student.CSVCode.Search.Search;
import edu.brown.cs.student.server.ACS.DatasourceException;
import edu.brown.cs.student.server.CSV.LoadedCSV;
import java.util.Collections;
import java.util.List;
import java.util.Set;
import spark.Request;
import spark.Response;
import spark.Route;

/** Class for handling search csv query Returns rows found with searched item */
public class SearchHandler implements Route {
  /** LoadedCSV class to reference loaded csv */
  LoadedCSV loadedCSV;

  /**
   * Constructor
   *
   * @param loadedCSV LoadedCSV with parsed csv to search
   */
  public SearchHandler(LoadedCSV loadedCSV) {
    this.loadedCSV = loadedCSV;
  }

  /**
<span class="nc" id="L32">   * Method to handly query</span>
<span class="nc" id="L33">   *</span>
<span class="nc" id="L34">   * @param request searchcsv suery from user</span>
   * @param response message with useful information and message with rows containing searched itm
   * @throws Exception
   */
  @Override
  public Object handle(Request request, Response response) throws Exception {

    String searchTerm = &quot;&quot;;
    ColumnIdentifier.Identifier searchType = ColumnIdentifier.Identifier.NONE;
    String identifier = &quot;&quot;;
    boolean hasHeaders = true;

<span class="nc" id="L46">    Set&lt;String&gt; params = request.queryParams();</span>
<span class="nc" id="L47"></span>
<span class="nc" id="L48">    if (!this.loadedCSV.getIsLoaded()) {</span>
<span class="nc" id="L49">      return new FailureToSearch(</span>
          &quot;error_datasource&quot;,
<span class="nc" id="L51">          params.toString(),</span>
          &quot;No csv loaded. Use endpoint 'loadcsv' with a path &quot;
<span class="nc bnc" id="L53" title="All 2 branches missed.">              + &quot;to your csv to load, then search.&quot;);</span>
<span class="nc" id="L54">    }</span>

    if (params.contains(&quot;term&quot;)) {
      searchTerm = request.queryParams(&quot;term&quot;);
    } else {
<span class="nc bnc" id="L59" title="All 2 branches missed.">      return new FailureToSearch(</span>
<span class="nc" id="L60">          &quot;error_bad_request&quot;, params.toString(), &quot;Must have parameter 'term' for term to search.&quot;);</span>
    }
<span class="nc" id="L62"></span>
    if (params.contains(&quot;type&quot;)) {
      if (request.queryParams(&quot;type&quot;).equals(&quot;header&quot;)) {
        searchType = ColumnIdentifier.Identifier.HEADER;
<span class="nc bnc" id="L66" title="All 2 branches missed."></span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (params.contains(&quot;column&quot;)) {</span>
<span class="nc" id="L68">          identifier = request.queryParams(&quot;column&quot;);</span>
        } else {
<span class="nc bnc" id="L70" title="All 2 branches missed.">          return new FailureToSearch(</span>
<span class="nc" id="L71">              &quot;error_bad_request&quot;,</span>
              params.toString(),
<span class="nc" id="L73">              &quot;Since you are trying to search by header, you must &quot;</span>
                  + &quot;request parameter 'column' equal to header name you &quot;
                  + &quot;want to search.&quot;);
        }

      } else if (request.queryParams(&quot;type&quot;).equals(&quot;index&quot;)) {
<span class="nc bnc" id="L79" title="All 2 branches missed.">        searchType = ColumnIdentifier.Identifier.INDEX;</span>
<span class="nc" id="L80"></span>
        if (params.contains(&quot;column&quot;)) {
<span class="nc bnc" id="L82" title="All 2 branches missed.">          identifier = request.queryParams(&quot;column&quot;);</span>
<span class="nc" id="L83">        } else {</span>
          return new FailureToSearch(
<span class="nc" id="L85">              &quot;error_bad_request&quot;,</span>
              params.toString(),
              &quot;Since you are trying to search by column, you must &quot;
                  + &quot;request parameter 'column' equal to column index you &quot;
                  + &quot;want to search.&quot;);
        }

<span class="nc" id="L92">      } else {</span>
        return new FailureToSearch(
            &quot;error_bad_request&quot;,
            params.toString(),
            &quot;Parameter 'type' must be either 'header' to search&quot;
                + &quot; by header name, or 'index' to search by column index.&quot;);
<span class="nc bnc" id="L98" title="All 2 branches missed.">      }</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">    }</span>
<span class="nc" id="L100"></span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">    if (params.contains(&quot;hasHeaders&quot;)) {</span>
<span class="nc" id="L102">      if (request.queryParams(&quot;hasHeaders&quot;).equals(&quot;true&quot;)) {</span>
        hasHeaders = true;
<span class="nc" id="L104">      } else if (request.queryParams(&quot;hasHeaders&quot;).equals(&quot;false&quot;)) {</span>
        hasHeaders = false;
      } else {
        return new FailureToSearch(
            &quot;error_bad_request&quot;,
<span class="nc" id="L109">            params.toString(),</span>
            &quot;Parameter hasHeaders must be either 'true' or 'false'.&quot;);
      }
<span class="nc" id="L112">    }</span>

<span class="nc" id="L114">    List&lt;List&lt;String&gt;&gt; rows = Collections.emptyList();</span>

<span class="nc" id="L116">    try {</span>
      Search search =
<span class="nc" id="L118">          new Search(</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">              this.loadedCSV.getParsedCSV(), searchTerm, searchType, identifier, hasHeaders, false);</span>
<span class="nc" id="L120"></span>
      rows = search.searchParsed();

    } catch (DatasourceException d) {
<span class="nc bnc" id="L124" title="All 2 branches missed.">      if (d.getMessage().equals(&quot;Index was not a number&quot;)) {</span>
<span class="nc" id="L125">        return new FailureToSearch(</span>
            &quot;error_bad_request&quot;,
<span class="nc" id="L127">            params.toString(),</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            &quot;Parameter 'column', if index, must be a number &quot;</span>
<span class="nc" id="L129">                + &quot;(1, 15, 0). You requested &quot;</span>
                + identifier);
<span class="nc" id="L131"></span>
      } else if (d.getMessage().equals(&quot;Header was not found&quot;)) {
<span class="nc" id="L133">        return new FailureToSearch(</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            &quot;error_bad_request&quot;,</span>
<span class="nc" id="L135">            params.toString(),</span>
<span class="nc" id="L136">            &quot;Header was not found. Headers are: &quot;</span>
                + this.loadedCSV.getParsedCSV().get(0)
<span class="nc" id="L138">                + &quot;. You requested &quot;</span>
<span class="nc" id="L139">                + identifier);</span>
      } else if (d.getMessage().equals(&quot;Index was to big&quot;)) {
        return new FailureToSearch(
            &quot;error_bad_request&quot;,
            params.toString(),
            &quot;Parameter 'column', if index, was to big. &quot;
                + &quot;CSV size is &quot;
                + this.loadedCSV.getParsedCSV().get(0).size()
                + &quot;. You requested &quot;
                + identifier);
<span class="nc" id="L149">      }</span>
    }
    if (rows.isEmpty()) {
      return new SuccessfullySearched(
              rows, params.toString(), &quot;'&quot; + searchTerm + &quot;' Was not found.&quot;)
          .serialize();
    }
    return new SuccessfullySearched(
<span class="nc" id="L157">            rows, params.toString(), &quot;'&quot; + searchTerm + &quot;' Was found in &quot; + rows.size() + &quot; rows.&quot;)</span>
<span class="nc" id="L158">        .serialize();</span>
  }

  /**
   * Record for when item as successfully searched for
   *
   * @param result success
<span class="nc" id="L165">   * @param rows rows item was found in</span>
   * @param params params passed into query
<span class="nc" id="L167">   * @param SUCCESSMESSAGE message telling user how many rows item was found in</span>
<span class="nc" id="L168">   */</span>
<span class="nc" id="L169">  public record SuccessfullySearched(</span>
<span class="nc" id="L170">      String result, List&lt;List&lt;String&gt;&gt; rows, String params, String SUCCESSMESSAGE) {</span>
<span class="nc" id="L171">    /**</span>
<span class="nc" id="L172">     * Constructor</span>
<span class="nc" id="L173">     *</span>
     * @param rows rows item was found in
     * @param params params passed into query
     * @param SUCCESSMESSAGE message telling user how many rows item was found in
     */
    public SuccessfullySearched(List&lt;List&lt;String&gt;&gt; rows, String params, String SUCCESSMESSAGE) {
      this(&quot;success&quot;, rows, params, SUCCESSMESSAGE);
    }
    /**
     * Method serialize message into json
     *
     * @return json of success message, rows, params
<span class="nc" id="L185">     */</span>
    String serialize() {
      try {
        Moshi moshi =
            new Moshi.Builder()
                .add(PolymorphicJsonAdapterFactory.of(LoadedCSV.class, &quot;path&quot;))
                .build();
        JsonAdapter&lt;SuccessfullySearched&gt; adapter = moshi.adapter(SuccessfullySearched.class);
<span class="nc" id="L193">        return adapter.toJson(this);</span>
<span class="nc" id="L194">      } catch (Exception e) {</span>
        e.printStackTrace();
        throw e;
      }
    }
  }

<span class="nc" id="L201">  /**</span>
<span class="nc" id="L202">   * Record for when search failed</span>
   *
   * @param result correct error message
   * @param params params passed into query
   * @param ERRORMESSAGE message informing user of what went wrong and options to fix
   */
  public record FailureToSearch(String result, String params, String ERRORMESSAGE) {
    /**
     * Constructor
     *
     * @param params params passed into query
     * @param ERRORMESSAGE message informing user of what went wrong and options to fix
     */
    public FailureToSearch(String params, String ERRORMESSAGE) {
      this(&quot;failure&quot;, params, ERRORMESSAGE);
    }

    /**
     * Method serialize message into json
     *
     * @return json of failure message
     */
    String serialize() {
      Moshi moshi = new Moshi.Builder().build();
      return moshi.adapter(FailureToSearch.class).toJson(this);
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>